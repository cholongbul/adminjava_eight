<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AdminLTE 3 | ChartJS</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
</head>
<body class="hold-transition layout-top-nav">
<div class="wrapper">

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>DashBoard 초기 설정</h1>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content" style="height: calc(100vh - 130px)">
            <div class="container">
                <div class="col-md-12">
                    <!-- AREA CHART -->
                    <div class="card card-indigo">
                        <div class="card-header" id="chart-chard-header">
                            <h1 class="card-title" id="barOrMix-title">설정</h1>

                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong>지점 선택</strong>
                                    </div>

                                    <div class="btn-group-toggle mb-5" data-toggle="buttons">
                                        <div class="btn-group-toggle">
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="Asite" value="Asite"
                                                       autocomplete="off">
                                                A지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="Bsite" value="Bsite"
                                                       autocomplete="off">
                                                B지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a3" value="Bsite"
                                                       autocomplete="off"> C지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a4" value="Bsite"
                                                       autocomplete="off"> D지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a5" value="Bsite"
                                                       autocomplete="off"> E지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a6" value="Bsite"
                                                       autocomplete="off"> F지점
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle">

                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a7" value="Bsite"
                                                       autocomplete="off"> A지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a8" value="Bsite"
                                                       autocomplete="off"> B지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a9" value="Bsite"
                                                       autocomplete="off"> C지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a10" value="Bsite"
                                                       autocomplete="off"> D지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a11" value="Bsite"
                                                       autocomplete="off"> E지점
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="siteoptions" id="option_a12" value="Bsite"
                                                       autocomplete="off"> F지점
                                            </label>
                                        </div>
                                    </div>
                                    <div class="btn-group-toggle mb-5" data-toggle="buttons">
                                        <div class="mb-3">
                                            <strong>화면 전환 시간</strong>
                                        </div>

                                        <div class="btn-group-toggle" data-toggle="buttons">
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="intervaloptions" id="interval_3" value="3"
                                                       autocomplete="off"> 3초 간격
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="intervaloptions" id="interval_5" value="5"
                                                       autocomplete="off"> 5초 간격
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="intervaloptions" id="interval_10" value="10"
                                                       autocomplete="off"> 10초
                                                간격
                                            </label>
                                            <label class="btn btn-outline-primary mr-2 mb-3">
                                                <input type="radio" name="intervaloptions" id="interval_15" value="15"
                                                       autocomplete="off"> 15초
                                                간격
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong>색채 선택</strong>
                                    </div>

                                    <div class="btn-group-toggle mb-5" data-toggle="buttons">
                                        <div class="btn-group-toggle">
                                            <label class="btn btn-primary mr-2 mb-3">
                                                <input type="radio" name="primary" id="primary" value="primary"
                                                       autocomplete="off">
                                                primary
                                            </label>
                                            <label class="btn btn-secondary mr-2 mb-3">
                                                <input type="radio" name="secondary" id="secondary" value="secondary"
                                                       autocomplete="off">
                                                Secondary
                                            </label>
                                            <label class="btn btn-info mr-2 mb-3">
                                                <input type="radio" name="info" id="info" value="info"
                                                       autocomplete="off"> Info
                                            </label>
                                            <label class="btn btn-success mr-2 mb-3">
                                                <input type="radio" name="success" id="success" value="success"
                                                       autocomplete="off"> success
                                            </label>
                                            <label class="btn btn-warning mr-2 mb-3">
                                                <input type="radio" name="warning" id="warning" value="warning"
                                                       autocomplete="off"> warning
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle">

                                            <label class="btn btn-danger mr-2 mb-3">
                                                <input type="radio" name="danger" id="danger" value="danger"
                                                       autocomplete="off"> danger
                                            </label>


                                            <label class="btn mr-2 mb-3 bg-indigo">
                                                <input type="radio" name="indigo" id="indigo" value="indigo"
                                                       autocomplete="off"> indigo
                                            </label>
                                            <label class="btn mr-2 mb-3 bg-lightblue">
                                                <input type="radio" name="lightblue" id="lightblue" value="lightblue"
                                                       autocomplete="off"> lightblue
                                            </label>
                                            <label class="btn bg-navy mr-2 mb-3">
                                                <input type="radio" name="navy" id="navy" value="navy"
                                                       autocomplete="off"> navy
                                            </label>
                                            <label class="btn bg-purple mr-2 mb-3">
                                                <input type="radio" name="purple" id="purple" value="purple"
                                                       autocomplete="off"> purple
                                            </label>
                                            <label class="btn bg-fuchsia mr-2 mb-3">
                                                <input type="radio" name="fuchsia" id="fuchsia" value="fuchsia"
                                                       autocomplete="off"> fuchsia
                                            </label>
                                        </div>
                                        <div class="btn-group-toggle">

                                            <label class="btn bg-pink mr-2 mb-3">
                                                <input type="radio" name="pink" id="pink" value="pink"
                                                       autocomplete="off"> pink
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.card-body -->

                        <div class="card-footer">
                            <button type="submit" id="chartStartBtn" class="btn btn-primary">실행</button>
                        </div>
                    </div>

                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <footer class="main-footer">
        <strong>Copyright &copy; 2022 <a href="http://cnkplus.com/">CNKPlus.com</a></strong>
    </footer>
    <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="plugins/chart.js/Chart.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/chart/options.js"></script>
<script src="dist/js/chart/datasetting.js"></script>
<script src="dist/js/chart/createchart.js"></script>
<script src="dist/js/cookie.js"></script>
<!-- Page specific script -->
<script>
    if (!(getCookie('localsite') === undefined) && !(getCookie('intervaltime') === undefined)) {
        $("input:radio[id='" + getCookie('localsite') + "']").prop("checked", true)
        $("input:radio[id='interval_" + getCookie('intervaltime') + "']").prop("checked", true)
    }
    $('#chartStartBtn').click(function () {
        let localsite = $('input[name="siteoptions"]:checked').val();
        let intervaltime = $('input[name="intervaloptions"]:checked').val();
        if (localsite === undefined || intervaltime === undefined) {
            alert("지점 및 화면 전환 간격을 선택해주세요.")
        } else {

            $('.content-wrapper').remove();
            $('.wrapper').prepend("  <!-- Content Wrapper. Contains page content -->\n" +
                "  <div class=\"content-wrapper\">\n" +
                "    <!-- Content Header (Page header) -->\n" +
                "    <section class=\"content-header\">\n" +
                "      <div class=\"container-fluid\">\n" +
                "        <div class=\"row mb-2\">\n" +
                "          <div class=\"col-sm-6\">\n" +
                "          </div>\n" +
                "        </div>\n" +
                "      </div><!-- /.container-fluid -->\n" +
                "    </section>\n" +
                "\n" +
                "    <!-- Main content -->\n" +
                "    <section class=\"content\" style=\"height: calc(100vh - 130px)\">\n" +
                "      <div class=\"container-fluid\">\n" +
                "        <div class=\"col-md-12\">\n" +
                "          <!-- AREA CHART -->\n" +
                "          <div class=\"card card-primary\">\n" +
                "            <div class=\"card-header\" id=\"chart-card-header\">\n" +
                "              <h1 class=\"card-title\" style=\"font-size: 1.8rem\" id=\"barOrMix-title\">Area Chart</h1>\n" +
                "            </div>\n" +
                "            <div class=\"card-body\">\n" +
                "              <div class=\"chart interval-chart\">\n" +
                "                <canvas id=\"barOrMixChart\"\n" +
                "                        style=\"height: calc(100vh - 180px); width:100vw\"></canvas>\n" +
                "              </div>\n" +
                "            </div>\n" +
                "            <!-- /.card-body -->\n" +
                "          </div>\n" +
                "\n" +
                "\n" +
                "        </div>\n" +
                "        <!-- /.card -->\n" +
                "\n" +
                "      </div><!-- /.container-fluid -->\n" +
                "    </section>\n" +
                "    <!-- /.content -->\n" +
                "  </div>");

            draw_chart(localsite, intervaltime);
            openFullScreenMode();
        }
    });

    let doc = document.documentElement;

    function openFullScreenMode() {
        if (doc.requestFullscreen)
            doc.requestFullscreen();
        else if (doc.webkitRequestFullscreen) // Chrome, Safari (webkit)
            doc.webkitRequestFullscreen();
        else if (doc.mozRequestFullScreen) // Firefox
            doc.mozRequestFullScreen();
        else if (doc.msRequestFullscreen) // IE or Edge
            doc.msRequestFullscreen();
        $('.fullscreen').hide();
        $('.close-fullscreen').show();
    };

    let draw_chart = function (localsite, intervaltime) {
        /* ChartJS
     * -------
     * Here we will create a few charts using ChartJS
     */
        // 변수선언
        const chartnamelist = ["delivery", "revenue", "stock"]
        let reqcnt = 0 //요청 파라미터
        let header_height = document.getElementsByClassName('content-header')[0].offsetHeight;
        let footer_height = document.getElementsByClassName('main-footer')[0].offsetHeight;
        let card_header_height = document.getElementById('chart-card-header').offsetHeight;

        setCookie("localsite", localsite, 60);
        setCookie("intervaltime", intervaltime, 60);

        console.log(intervaltime + "초 간격")
        console.log(localsite + "지역")
        getXmlData(); //화면 로딩 데이터
        var interval = setInterval(getXmlData, intervaltime * 1000); // 반복 요청 데이터


        //ajax xmldata 요청
        function getXmlData() {
            $.ajax({
                type: "GET",
                url: "getData.do?chartname=" + chartnamelist[reqcnt] + "&local=" + localsite, //요청변수에 따른 반환 데이터 변경
                dataType: "xml",
                //ajax요청
                success: handleData,
                error: handleError
            });
        };


        //xml데이터 처리
        function handleData(xml) {

            //xml변수선언
            let xmlcnt = getCookie("xmlcnt");
            let parsingXml = parserXml(xml);
            let label2d = parsingXml[0];
            let data2d = parsingXml[1];
            let datanamelist = parsingXml[2];
            let chartname = parsingXml[3];
            let chart_height = screen.height - header_height - footer_height - card_header_height - 60; //반응형 차트 높이

            //메소드
            $("#barOrMix-title").text(chartname + " - " + getCookie("localsite")) //차트 제목 변경
            $(".interval-chart").html('</div><canvas id="barOrMixChart" style="width:100vw"></canvas>'); //새로운 그래프 리셋
            $("#barOrMixChart").css('height', chart_height + 'px'); //차트 높이 설정
            if (chartnamelist[reqcnt] == "revenue") {
                let data = setdata(label2d, data2d, datanamelist);
                let option = setOptions();
                createBarChart(data, option); //막대 차트 적용
            }
            if (chartnamelist[reqcnt] == "delivery") {
                let data = setmultidata(label2d, data2d, datanamelist);
                let option = setOptions();
                createMultiLineChart(data, option); //멀티 라인 차트 적용
            }
            if (chartnamelist[reqcnt] == "stock") {
                let data = setmultiLineBarData(label2d, data2d, datanamelist);
                let option = setmultiLineBarOption();
                createLineBarChart(data, option); //데이터명 적용
            }

            if (reqcnt + 1 == xmlcnt) {
                reqcnt = 0;
            } else {
                reqcnt++
            }

        }

        function handleError(request, status, error) {
            console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            clearInterval(interval);
        }


        //xml파싱, 변수 추출
        function parserXml(xml) {
            let datanamelist = [];
            let label2d = [];
            let data2d = [];
            let chartname;
            let result = []
            // xml파싱
            $(xml).find("chart").each(function () {
                chartname = $(this).find("chartname").text();

                $(this).find("dataset").each(function (i) {
                    let labellist = [];
                    let datalist = [];
                    datanamelist.push($(this).find("dataname").text());
                    $(this).find("item").each(function (i) {
                        datalist.push($(this).find("data").text());
                        labellist.push($(this).find("label").text());
                    });
                    label2d.push(labellist);
                    data2d.push(datalist);
                });
            });


            result.push(label2d);
            result.push(data2d);
            result.push(datanamelist);
            result.push(chartname);
            return result;
        };


    };

</script>
</body>
</html>
